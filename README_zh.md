# 饥荒 - 反编译源代码

这个仓库包含热门生存游戏 **《饥荒》** 的Lua源代码的反编译版本。这个项目的主要目的是作为教育、研究和模组制作的资源。通过研究这些代码，开发者和爱好者可以更深入地了解游戏的游戏机制、人工智能和整体架构。

## ❗ 免责声明

本项目与《饥荒》的开发者Klei Entertainment无关，也未受其认可。本仓库中的代码是通过反编译获得的，仅用于教育和研究目的。它不用于创建未经授权的游戏副本或任何其他商业用途。如果您还没有购买游戏，请通过购买来支持开发者。

## 📁 目录结构

本仓库分为几个关键目录。以下是最重要目录的明细：

-   `data/`: 这是游戏资源的主目录。它包含了从动画（`anim`）和图像（`images`）到声音（`sound`）和核心游戏脚本（`scripts`）的所有内容。
-   `data/scripts/`: 游戏逻辑的核心。该目录包含所有定义游戏机制、实体和系统的Lua脚本。
-   `data/scripts/prefabs/`: 包含游戏中所有“预制件”的定义。预制件是游戏对象的模板，例如角色、怪物、物品或一块风景。
-   `data/scripts/components/`: 该目录包含可以附加到实体以赋予它们特定行为和属性的各种组件（例如，`health`、`inventory`、`combat`）。
-   `data/scripts/brains/`: 这里定义了游戏中生物的人工智能。每个大脑都使用行为树来控制生物的行动。
-   `mods/`: 该目录包含如何为游戏创建模组的示例。它包括用于添加角色、预制件和自定义组件的示例模组。
-   `docs/`: 包含附加文档，例如对游戏中使用的行为树系统的解释。

## ⚙️ 核心引擎概念

游戏引擎建立在一些关键概念之上，在深入研究代码之前了解这些概念非常重要。

### 实体-组件系统 (ECS)

《饥荒》使用实体-组件系统（ECS）架构。这是一种倾向于组合而非继承的设计模式。

-   **实体:** 实体是一个通用对象。在《饥荒》中，从玩家角色到地上一块燧石的任何东西都是一个实体。
-   **组件:** 组件是可以附加到实体的数据块。例如，一个 `health` 组件可以附加到任何可以受到伤害的实体上。
-   **系统:** 系统是操作具有特定组件的实体的逻辑。例如，一个 `combatsystem` 将处理具有 `health` 和 `combat` 组件的实体之间的交互。

您可以在 `data/scripts/components/` 中找到组件定义。

### 用于AI的行为树

游戏中所有生物的人工智能都是使用行为树实现的。行为树是一种分层的决策模型。

-   行为树的核心实现可以在 `data/scripts/behaviourtree.lua` 中找到。
-   每个生物的AI逻辑都在其“大脑”中定义，可以在 `data/scripts/brains/` 中找到。
-   `docs/` 目录包含对行为树代码的详细分解。

### 事件驱动逻辑

游戏的大部分逻辑是事件驱动的。这意味着代码的不同部分可以“监听”特定事件，然后对它们做出反应。

-   事件用于从角色受到伤害到一天中时间变化的所有事情。
-   `ListenForEvent` 函数用于为特定事件注册回调。
-   这创建了一个解耦的架构，其中不同的系统可以在没有直接依赖关系的情况下进行交互。

## 🔧 模组制作指南

《饥荒》拥有一个强大而灵活的模组系统。`mods/` 目录包含几个可以用作起点的示例。以下是根据 `samplemod` 创建您自己的模组的指南。

### `modinfo.lua`

该文件包含您模组的元数据。这是一个简单的Lua脚本，定义了几个关键变量：

-   `name`: 你的模组名称。
-   `description`: 你的模组功能的简要说明。
-   `author`: 你的名字。
-   `version`: 你的模组的版本号。
-   `forumthread`: 指向Klei论坛上模组帖子的链接。
-   `api_version`: 你的模组兼容的API版本。

### `modmain.lua`

这是您模组逻辑的主要入口点。您将在这里接入游戏以进行更改。以下是您可以使用的一些关键函数：

-   `AddPrefabPostInit(prefab_name, fn)`: 此函数允许您在特定预制件初始化后运行自定义函数。这对于修改现有游戏对象很有用。
-   `AddComponentPostInit(component_name, fn)`: 与上述类似，但用于组件。这使您可以修改组件的行为。
-   `AddSimPostInit(fn)`: 此函数在模拟初始化后运行一次。
-   `AddGamePostInit(fn)`: 此函数在游戏初始化后运行一次。

### 示例：修改威尔逊

以下是 `samplemod/modmain.lua` 中的一个示例，展示了如何修改角色威尔逊：

```lua
function wilsonpostinit(inst)
    -- 将威尔逊的最大饥饿值减半
    inst.components.hunger:SetMax(TUNING.WILSON_HUNGER * 0.5)

    -- 添加一个自定义组件
    inst:AddComponent("myowncomponent")
end

AddPrefabPostInit("wilson", wilsonpostinit)
```

在此示例中，`wilsonpostinit` 函数被注册为在“wilson”预制件初始化后运行。然后它会更改威尔逊的最大饥饿值并添加一个新的自定义组件。

### 修改Tuning变量

您可以直接在 `modmain.lua` 文件中覆盖游戏的Tuning变量。例如：

```lua
-- 将威尔逊的默认饥饿值减半
TUNING.WILSON_HUNGER = 50
```

这将改变整个游戏中 `WILSON_HUNGER` 的值。

## 🚀 如何使用本仓库

对于任何想要更多地了解《饥荒》如何工作的人来说，这个仓库是一个宝贵的资源。以下是一些入门建议：

-   **探索 `prefabs`:** `data/scripts/prefabs/` 目录是一个很好的起点。选择一个您熟悉的角色或物品，并通读其源代码。这将使您很好地了解游戏对象是如何构建的。
-   **阅读 `brains`:** 如果您对AI感兴趣，请查看 `data/scripts/brains/` 目录。您可以看到行为树如何用于创建游戏中生物复杂且通常不可预测的行为。
-   **尝试制作一个模组:** 学习的最佳方式是实践。尝试创建一个简单的模组来更改Tuning变量或修改角色。使用 `samplemod` 作为指南。
-   **追踪代码:** 在游戏中选择一个动作，比如砍树，然后尝试追踪实现它的代码。从 `actions.lua` 文件开始，然后跟随事件链。

## 🙌 贡献

这个项目是一个社区的努力，欢迎贡献！以下是您可以提供帮助的几种方式：

-   **改进文档:** 如果您弄清楚了某个特定系统的工作原理，请考虑添加到此README或在 `docs/` 目录中编写新文档。
-   **为代码添加注释:** 大部分代码都没有注释。添加注释来解释代码的工作原理将对他人有很大帮助。
-   **修复反编译源代码中的错误:** 反编译过程并不完美，代码中可能存在错误。如果您发现并修复了一个，请提交一个pull request。
